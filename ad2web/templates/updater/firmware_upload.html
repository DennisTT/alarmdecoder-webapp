
{% from "macros/_form.html" import render_form %}


{% extends 'layouts/base.html' %}

{% set page_title = 'AlarmDecoder Firmware Update' %}

{% block css %}
<style>
#upload-status {
    width: 400px;
    height: 20px;
}

.ui-progressbar {
    position: relative;
}

.ui-progressbar-value {
    background: #78aee6 none 50% 50% repeat-x !important;
}

.progress-label {
    position: absolute;
    left: 5%;
    top: 1px;
    font-size: 11px;
    font-weight: bold;
    color: #3b3b3b;
}
</style>
{% endblock %}

{% block pagejs %}
<script type="text/javascript">
    $(document).ready(function() {
        PubSub.subscribe('firmwareupload', function(type, msg) {
            result_text = { 
                'PASS': '<span style="color:green">&#10004;</span>', 
                'FAIL': '<span style="color:red">&#10008;</span>',
                'TIMEOUT': '<span style="color:orange">&#9888;</span>'
            };

            var stage = msg.stage;
            var upload_label = $('div#upload-label');
            var upload_progressbar = $('div#upload-status');
            if (stage == "STAGE_START") {
                upload_label.text("Starting upload..");
            }
            else if (stage == "STAGE_WAITING") {
                upload_label.text("Waiting for device..");
            }
            else if (stage == "STAGE_BOOT") {
                upload_label.text("Rebooting device..");
            }
            else if (stage == "STAGE_LOAD") {
                upload_label.text("Waiting for boot loader..");
            }
            else if (stage == "STAGE_UPLOADING") {
                upload_label.text("Uploading firmware: " + msg.percent + "%");
                upload_progressbar.progressbar({ value: msg.percent });
            }
            else if (stage == "STAGE_DONE") {
                upload_label.text("Firmware upload complete!");
                upload_progressbar.progressbar({ value: 100 });
            }
            else if (stage == "STAGE_CONFIGURE") {
                upload_label.text("Reconfiguring device..");
            }
            else if (stage == "STAGE_FINISHED") {
                upload_label.text("Complete!");
            }
            else if (stage == "STAGE_ERROR") {
                upload_label.text("ERROR: " + msg.error);
                upload_label.style("color: #ff0000;");
                upload_progressbar.progressbar({ value: -1 });
            }
        });

        $('div#upload-status').progressbar({ value: false });
        decoder.emit('firmwareupload', '{{ filename }}');
    });
</script>
{% endblock %}

{% block body %}
<div class="settings_wrapper">
    <h3>Firmware Update Progress</h3>
    <div id="upload-status"><div id="upload-label" class="progress-label">Please wait..</div></div>
</div>
{% endblock %}

{% block js_btm %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/smoothness/jquery-ui-1.10.4.custom.css') }}">
<script src="{{ url_for('static', filename='js/vendor/jquery-ui-1.10.4.custom.js') }}"></script>
{% endblock %}
